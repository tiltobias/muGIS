import{e as $,f as c,j as e,M as Q,S as Y,F as _,h as D,k as ee,l as te,m as se,G as re,X as z,n as ne,C as oe,o as le,q as ie,t as ae,w as ce,x as ue,y as de,z as fe,E as pe,T as me,A as xe,Z as he,P as ye,B as je,D as q,H as V,I as W,J as O,K as I,L as be,N as ge,O as ve,U as Le,Q as Ce}from"./vendor-CRirZrQV.js";import{m as M,M as Se}from"./vendor-mapbox-wB3FEiz7.js";import{b as H,i as J,u as Ne,c as we,d as ke,a as B,f as k,v as Pe,e as F,g as Ee,p as Te,h as A,l as Me}from"./vendor-turf-Di0ZtkTO.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const a of l.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function o(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerPolicy&&(l.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?l.credentials="include":n.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function r(n){if(n.ep)return;n.ep=!0;const l=o(n);fetch(n.href,l)}})();const P=$(s=>({mapRef:c.createRef(),setMapRef:t=>s({mapRef:t}),mapReady:!1,setMapReady:t=>s({mapReady:t}),basemap:{url:"mapbox://styles/mapbox/streets-v12",name:"Streets"},setBasemap:t=>s(o=>t.url===o.basemap.url?o:{basemap:t}),resetMapStore:()=>s(()=>({mapReady:!1,basemap:{url:"mapbox://styles/mapbox/streets-v12",name:"Streets"}}))})),L=$(s=>({layers:[],resetLayerStore:()=>s(()=>({layers:[]})),loadProjectLayers:t=>s(()=>({layers:t})),addLayer:t=>s(o=>{const r=u=>o.layers.some(i=>i.id===u)?r(u+"1"):u,n=t.featureCollection.features[0].geometry.type,l=n==="Polygon"||n==="MultiPolygon"?"fill":n==="LineString"||n==="MultiLineString"?"line":n==="Point"||n==="MultiPoint"?"circle":null;if(!l)throw new Error("Unsupported geometry type: "+n);t.name||(t.name=l==="fill"?"polygon":l==="line"?"line":l==="circle"?"point":"not possible");const a={h:Math.floor(Math.random()*360),s:90,l:48,a:l==="fill"?.7:1};return{layers:[{featureCollection:t.featureCollection,id:r(t.name),name:t.name,renderingType:l,visible:!0,color:a,outline:t.outline},...o.layers]}}),moveLayerUp:t=>s(o=>{const r=o.layers.findIndex(l=>l.id===t);if(r===0)return o;const n=[...o.layers];return n.splice(r-1,0,n.splice(r,1)[0]),{layers:n}}),moveLayerDown:t=>s(o=>{const r=o.layers.findIndex(l=>l.id===t);if(r===o.layers.length-1)return o;const n=[...o.layers];return n.splice(r+1,0,n.splice(r,1)[0]),{layers:n}}),deleteLayer:t=>s(o=>({layers:o.layers.filter(r=>r.id!==t)})),toggleLayerVisibility:t=>s(o=>({layers:o.layers.map(r=>r.id===t?{...r,visible:!r.visible}:r)})),toggleLayerVisibilityAll:()=>s(t=>{const o=t.layers.every(r=>r.visible);return{layers:t.layers.map(r=>({...r,visible:!o}))}}),changeLayerColor:(t,o)=>s(r=>({layers:r.layers.map(n=>n.id===t?{...n,color:o}:n)})),updateAllLayers:()=>s(t=>({layers:t.layers.map(o=>({...o,updater:o.updater?o.updater+1:1}))})),changeLayerName:(t,o)=>s(r=>({layers:r.layers.map(n=>n.id===t?{...n,name:o}:n)}))}));M.accessToken="pk.eyJ1IjoidG9iaWFuZCIsImEiOiJjbTdiMGZwemwwNmxlMnFyNTV4YWh2ZzB3In0.B3fVZMQOYEs2V23kKWB5XQ";const Re=()=>{const{mapRef:s,mapReady:t,setMapReady:o,basemap:r}=P(),{addLayer:n,updateAllLayers:l}=L(),a=c.useRef(null);c.useEffect(()=>{var m,g,v,x,y,p;if(!t&&a.current){a.current.innerHTML="",s.current=new M.Map({container:a.current,style:r.url,center:[10.4,63.425],zoom:12}),(m=s.current)==null||m.addControl(new M.FullscreenControl,"top-right"),(g=s.current)==null||g.addControl(new M.NavigationControl({visualizePitch:!0}),"top-right"),(v=s.current)==null||v.addControl(new M.ScaleControl,"bottom-right");const j=new Se({displayControlsDefault:!1,controls:{point:!0,line_string:!0,polygon:!0},boxSelect:!1});(x=s.current)==null||x.addControl(j,"bottom-left"),(y=s.current)==null||y.on("draw.create",()=>{n({featureCollection:j.getAll(),name:null}),j.deleteAll()}),(p=s.current)==null||p.on("style.load",()=>{o(!0)})}},[s,n,t,o,r]);const[d,u]=c.useState(!1),i=c.useRef(r),[f,h]=c.useState(r);return c.useEffect(()=>{var m;i.current.url!==r.url&&(i.current=r),!d&&f.url!==i.current.url&&(u(!0),t&&s.current&&(s.current.setStyle(i.current.url),h(r)),(m=s.current)==null||m.once("style.load",()=>{l()}),setTimeout(()=>{u(!1)},200))},[r,s,t,d,f,l]),e.jsx("div",{ref:a,className:"mapContainer"})},E=(s,t,o=[])=>{c.useEffect(()=>{const r=n=>{const l=n.target;s.current&&!s.current.contains(l)&&!o.some(a=>{var d;return(d=a.current)==null?void 0:d.contains(l)})&&t()};return document.addEventListener("click",r),()=>{document.removeEventListener("click",r)}},[s,t,o])},$e=()=>{const[s,t]=c.useState(!1),o=c.useRef(null);E(o,()=>{t(!1)});const[r,n]=c.useState(null),{basemap:l,setBasemap:a}=P(),d=[{url:"mapbox://styles/mapbox/streets-v12",name:"Streets"},{url:"mapbox://styles/mapbox/outdoors-v12",name:"Outdoors"},{url:"mapbox://styles/mapbox/light-v11",name:"Light"},{url:"mapbox://styles/mapbox/dark-v11",name:"Dark"},{url:"mapbox://styles/mapbox/satellite-v9",name:"Satellite"},{url:"mapbox://styles/mapbox/satellite-streets-v12",name:"Satellite Streets"},{url:"mapbox://styles/mapbox/navigation-day-v1",name:"Navigation Day"},{url:"mapbox://styles/mapbox/navigation-night-v1",name:"Navigation Night"},{url:"mapbox://styles/tobiand/cm8rbg7j900be01sa5wc6d4lq",name:"Off (white)"},{url:"mapbox://styles/tobiand/cm8rbd89l00az01sb97a8hfyh",name:"Off (black)"}];return e.jsxs("div",{className:"basemap",ref:o,children:[e.jsxs("button",{type:"button",onClick:()=>t(!s),children:[e.jsx(Q,{})," Change basemap"]}),s&&e.jsx("div",{className:"basemapPopover",children:e.jsx("ul",{onMouseEnter:()=>{n(l)},onMouseLeave:()=>{a(r),n(null)},children:d.map(u=>e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:()=>{n(u)},onMouseEnter:()=>{a(u)},children:[r===null&&u.name===l.name||r!==null&&u.name===r.name?"*":"",u.name]})},u.name))})})]})},Fe=$(s=>({theme:localStorage.getItem("theme")||"light",setTheme:t=>s(o=>(localStorage.setItem("theme",t),t===o.theme?o:{theme:t}))})),Oe=()=>{const[s,t]=c.useState(!1),o=c.useRef(null);E(o,()=>{t(!1)});const{layers:r,resetLayerStore:n,loadProjectLayers:l}=L(),{basemap:a,setBasemap:d,resetMapStore:u}=P(),{theme:i,setTheme:f}=Fe(),h=()=>{n(),u()},m=()=>{const y={layers:r,basemap:a},p=new Blob([JSON.stringify(y)],{type:"application/json"}),j=URL.createObjectURL(p),b=document.createElement("a");b.href=j,b.download="μGIS_project.mugis",document.body.appendChild(b),b.click(),document.body.removeChild(b),URL.revokeObjectURL(j)},g=c.useRef(null),v=()=>{var y;(y=g.current)==null||y.click()},x=y=>{const p=y.target.files;if(!p){console.log("no file selected");return}const j=new FileReader;j.onload=b=>{var S;try{const N=JSON.parse((S=b.target)==null?void 0:S.result);l(N.layers),d(N.basemap)}catch(N){console.log(N)}},j.readAsText(p[0])};return c.useEffect(()=>{document.documentElement.setAttribute("data-theme",i)},[i]),e.jsxs("div",{className:"settings",ref:o,children:[e.jsx("button",{type:"button",onClick:()=>{t(!s)},children:e.jsx(Y,{})}),s&&e.jsx("div",{className:"settingsPopover",children:e.jsxs("ul",{children:[e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:h,children:[e.jsx(_,{})," New project"]})}),e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:m,children:[e.jsx(D,{})," Save project"]})}),e.jsxs("li",{children:[e.jsx("input",{ref:g,type:"file",accept:".mugis",onChange:x}),e.jsxs("button",{type:"button",onClick:v,children:[e.jsx(ee,{})," Load project"]})]}),e.jsx("li",{children:e.jsx($e,{})}),e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:y=>{y.stopPropagation(),f(i==="light"?"dark":"light")},children:[i==="light"?e.jsx(te,{}):e.jsx(se,{})," Toggle theme"]})}),e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:()=>{},children:[e.jsx(re,{})," Start tutorial"]})})]})})]})},w=({children:s,buttonLabel:t,onFormSubmit:o,buttonIcon:r})=>{const[n,l]=c.useState(!1),[a,d]=c.useState(!1);return e.jsxs("div",{children:[e.jsxs("button",{type:"button",className:"toolButton",onClick:()=>l(!n),children:[r," ",t]}),n&&e.jsx("div",{className:"cover",onClick:u=>{u.target===u.currentTarget&&l(!1)},children:e.jsx("div",{className:"modal"+(a?" loading":""),children:e.jsxs("form",{onSubmit:u=>{u.preventDefault(),d(!0),setTimeout(()=>{o()&&l(!1),d(!1)},0)},children:[e.jsx("button",{type:"button",className:"modalCloseButton",onClick:()=>l(!1),children:e.jsx(z,{})}),e.jsx("h3",{children:t}),s,e.jsx("button",{type:"submit",children:"Submit"})]})})})]})};function G({size:s=120}){return e.jsxs("svg",{width:s,height:s,viewBox:"0 0 120 120",version:"1.1",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{style:{fill:"none",stroke:"currentColor",strokeWidth:16,strokeLinejoin:"round",strokeOpacity:1},d:"M 15,55 50,80 70,40 105,65"}),e.jsx("circle",{cx:"15",cy:"55",r:"12",fill:"currentColor"}),e.jsx("circle",{cx:"50",cy:"80",r:"12",fill:"currentColor"}),e.jsx("circle",{cx:"70",cy:"40",r:"12",fill:"currentColor"}),e.jsx("circle",{cx:"105",cy:"65",r:"12",fill:"currentColor"})]})}function Z({size:s=120}){return e.jsx("svg",{width:s,height:s,viewBox:"0 0 120 120",version:"1.1",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("circle",{cx:"60",cy:"60",r:"25",fill:"currentColor"})})}function K({size:s=120}){return e.jsxs("svg",{width:s,height:s,viewBox:"0 0 120 120",version:"1.1",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{style:{fill:"currentColor",stroke:"currentColor",strokeWidth:16,strokeLinejoin:"round",strokeOpacity:1,fillOpacity:.5},d:"M 60,17 100,48 88,95 H 32 L 20,48 60,17"}),e.jsx("circle",{cx:"60",cy:"17",r:"12",fill:"currentColor"}),e.jsx("circle",{cx:"100",cy:"48",r:"12",fill:"currentColor"}),e.jsx("circle",{cx:"88",cy:"95",r:"12",fill:"currentColor"}),e.jsx("circle",{cx:"32",cy:"95",r:"12",fill:"currentColor"}),e.jsx("circle",{cx:"20",cy:"48",r:"12",fill:"currentColor"})]})}function Ie(){return e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{width:"20",height:"20",x:"2",y:"2",rx:"2"}),e.jsx("circle",{cx:"7",cy:"9",r:"1"}),e.jsx("circle",{cx:"9",cy:"17",r:"1"}),e.jsx("circle",{cx:"17",cy:"10",r:"1"}),e.jsx("line",{x1:"11.7436",y1:"12.0641",x2:"19.5625",y2:"21"}),e.jsx("line",{x1:"11.7436",y1:"12.0641",x2:"12.65",y2:"3"}),e.jsx("line",{x1:"11.7436",y1:"12.0641",x2:"3",y2:"14.25"})]})}const U=({name:s,type:t,index:o,color:r,onRemove:n})=>e.jsxs("div",{className:"layerItem",children:[e.jsxs("span",{className:"layerIndex",children:[o+1,"."]}),e.jsxs("div",{className:"colorPickerButton",style:{color:`hsl(${r.h},${r.s}%,${r.l}%)`},children:[t==="circle"&&e.jsx(Z,{}),t==="line"&&e.jsx(G,{}),t==="fill"&&e.jsx("div",{className:"polygonShrinker",children:e.jsx(K,{})})]}),e.jsx("div",{className:"layerName",children:e.jsx("span",{children:s})}),n&&e.jsx("button",{type:"button",onClick:l=>{n(),l.stopPropagation()},children:e.jsx(ne,{})})]}),C=({selectedLayers:s,setSelectedLayers:t,renderingType:o=void 0,multiple:r=!1,unselectableLayerIds:n=[]})=>{const{layers:l}=L(),[a,d]=c.useState(!1),u=c.useRef(null),i=c.useRef(null);return E(u,()=>{d(!1)}),c.useEffect(()=>{var f,h,m,g,v,x;u.current&&i.current&&((h=i.current)==null||h.style.setProperty("max-height",`${window.innerHeight-((f=u.current)==null?void 0:f.getBoundingClientRect().bottom)-10}px`),(g=i.current)==null||g.style.setProperty("width",`${(m=u.current)==null?void 0:m.getBoundingClientRect().width}px`),(x=i.current)==null||x.style.setProperty("top",`${((v=u.current)==null?void 0:v.getBoundingClientRect().bottom)+window.scrollY}px`))},[a,s]),c.useEffect(()=>{s.forEach(f=>{n.includes(f.id)&&t(h=>h.filter(m=>m.id!==f.id))})},[n,s,t]),e.jsxs("div",{className:"selectLayersContainer",ref:u,onClick:()=>{d(!a)},children:[e.jsx("ol",{className:"selectedList",children:s.length===0?e.jsx("p",{children:"No layer selected"}):l.map((f,h)=>o&&f.renderingType!==o||!s.some(m=>m.id===f.id)?null:e.jsx("li",{children:e.jsx(U,{name:f.name,type:f.renderingType,index:h,color:f.color,onRemove:()=>{t(m=>m.filter(g=>g.id!==f.id))}})},f.id))}),a&&e.jsxs("div",{className:"selectListContainer",onClick:f=>{r&&f.stopPropagation()},ref:i,children:[e.jsx("h4",{children:"Select Layers"}),e.jsx("ol",{className:"selectList",children:l.map((f,h)=>o&&f.renderingType!==o||s.some(m=>m.id===f.id)||n.includes(f.id)?null:e.jsx("li",{className:"selectListItem",onClick:()=>{t(r?m=>[...m,f]:[f])},children:e.jsx(U,{name:f.name,type:f.renderingType,index:h,color:f.color})},f.id))||e.jsx("p",{children:"No layers available"})})]})]})},Be=()=>{const{addLayer:s}=L(),[t,o]=c.useState([]),[r,n]=c.useState(""),[l,a]=c.useState("");c.useEffect(()=>{t[0]&&a(`buffer(${t[0].name}, ${r}m)`)},[t,r]);const d=()=>{if(!t[0]||r==="")return alert("Please select a layer and enter a radius"),!1;const u=t[0].featureCollection,i=H(u,r*.001,{units:"kilometers"});return!i||i.features.length===0?(alert("No results found"),!1):(s({featureCollection:i,name:l}),!0)};return e.jsxs(w,{buttonLabel:"Buffer",onFormSubmit:d,buttonIcon:e.jsx(oe,{}),children:[e.jsx(C,{selectedLayers:t,setSelectedLayers:o}),"buffer radius [m]: ",r,e.jsx("input",{type:"number",value:r,onChange:u=>n(u.target.value)}),e.jsx("input",{type:"text",value:l,onChange:u=>a(u.target.value)})]})},Ae=()=>{const{addLayer:s}=L(),[t,o]=c.useState([]),[r,n]=c.useState("");c.useEffect(()=>{if(t&&t.length>=2){let a=t[0].name;for(let d=1;d<t.length;d++)a+=`, ${t[d].name}`;n(`intersect(${a})`)}},[t]);const l=()=>{if(!t||t.length<2)return alert("Please select two layers"),!1;const a={type:"FeatureCollection",features:t[0].featureCollection.features};for(let d=1;d<t.length;d++){const u=t[d].featureCollection,i=[];a.features.forEach(f=>{u.features.forEach(h=>{const m=J({type:"FeatureCollection",features:[f,h]});m&&i.push(m)})}),a.features=i}return!a||a.features.length===0?(alert("No results found"),!1):(s({featureCollection:a,name:r}),!0)};return e.jsxs(w,{buttonLabel:"Intersect",onFormSubmit:l,buttonIcon:e.jsx(le,{}),children:[e.jsx(C,{selectedLayers:t,setSelectedLayers:o,renderingType:"fill",multiple:!0}),e.jsx("input",{type:"text",value:r,onChange:a=>n(a.target.value)})]})},Ue=()=>{const{addLayer:s}=L(),[t,o]=c.useState([]),[r,n]=c.useState("");c.useEffect(()=>{if(t&&t.length>=2){let a=t[0].name;for(let d=1;d<t.length;d++)a+=`, ${t[d].name}`;n(`union(${a})`)}},[t]);const l=()=>{if(!t||t.length<2)return alert("Please select two layers"),!1;const a=t.flatMap(u=>u.featureCollection.features),d=Ne({type:"FeatureCollection",features:a});return d?(s({featureCollection:{type:"FeatureCollection",features:[d]},name:r}),!0):(alert("No results found"),!1)};return e.jsxs(w,{buttonLabel:"Union",onFormSubmit:l,buttonIcon:e.jsx(ie,{}),children:[e.jsx(C,{selectedLayers:t,setSelectedLayers:o,renderingType:"fill",multiple:!0}),e.jsx("input",{type:"text",value:r,onChange:a=>n(a.target.value)})]})},ze=()=>{var u;const{addLayer:s}=L(),[t,o]=c.useState([]),[r,n]=c.useState([]),[l,a]=c.useState("");c.useEffect(()=>{t[0]&&r[0]&&a(`difference(${t[0].name}, ${r[0].name})`)},[t,r]);const d=()=>{if(!t[0]||!r[0])return alert("Please select two layers"),!1;const i={type:"FeatureCollection",features:[]},f=t[0].featureCollection,h=r[0].featureCollection,m=we(h).features[0];return f.features.forEach(g=>{const v=ke({type:"FeatureCollection",features:[g,m]});v&&i.features.push(v)}),!i||i.features.length===0?(alert("No results found"),!1):(s({featureCollection:i,name:l}),!0)};return e.jsxs(w,{buttonLabel:"Difference",onFormSubmit:d,buttonIcon:e.jsx(ae,{}),children:["select base layer:",e.jsx(C,{selectedLayers:t,setSelectedLayers:o,renderingType:"fill"}),"select layer to subtract:",e.jsx(C,{selectedLayers:r,setSelectedLayers:n,renderingType:"fill",unselectableLayerIds:[(u=t[0])==null?void 0:u.id]}),e.jsx("input",{type:"text",value:l,onChange:i=>a(i.target.value)})]})},qe=()=>{var f;const{addLayer:s}=L(),[t,o]=c.useState([]),[r,n]=c.useState(!1),[l,a]=c.useState(void 0),[d,u]=c.useState("");c.useEffect(()=>{t[0]&&u(r&&l?`dissolve(${t[0].name}, ${l})`:`dissolve(${t[0].name})`)},[t,r,l]);const i=()=>{if(!t[0])return alert("Please select a layer"),!1;const h=t[0].featureCollection,m=r&&l?B(k(h),{propertyName:l}):B(k(h));return!m||m.features.length===0?(alert("No results found"),!1):(s({featureCollection:m,name:d}),!0)};return e.jsxs(w,{buttonLabel:"Dissolve",onFormSubmit:i,buttonIcon:e.jsx(ce,{}),children:["select layer:",e.jsx(C,{selectedLayers:t,setSelectedLayers:o,renderingType:"fill"}),e.jsxs("span",{children:[e.jsx("input",{type:"checkbox",checked:r,onChange:h=>n(h.target.checked),id:"checkboxPropertyEnabled"}),e.jsxs("label",{htmlFor:"checkboxPropertyEnabled",children:["dissolve by property: ",r&&l]})]}),e.jsxs("select",{required:!0,disabled:!r,value:l,onChange:h=>a(h.target.value),children:[e.jsx("option",{value:"",children:"Select a property"}),((f=t[0])==null?void 0:f.featureCollection.features[0].properties)&&Object.keys(t[0].featureCollection.features[0].properties).map(h=>e.jsx("option",{value:h,children:h},h))]}),e.jsx("input",{type:"text",value:d,onChange:h=>u(h.target.value)})]})},Ve=()=>{const{addLayer:s}=L(),[t,o]=c.useState([]),[r,n]=c.useState(!1),[l,a]=c.useState([]),[d,u]=c.useState("");c.useEffect(()=>{t[0]&&(r&&l[0]?u(`voronoi(${t[0].name}, ${l[0].name})`):u(`voronoi(${t[0].name})`))},[t,l,r]);const i=()=>{if(!t[0])return alert("Please select a layer"),!1;const f=k(t[0].featureCollection),h=r&&l[0]?k(l[0].featureCollection):f,m=Pe(f,{bbox:F(h)});return!m||m.features.length===0?(alert("No results found"),!1):(m.features=m.features.filter(g=>g.geometry.type==="Polygon"),s({featureCollection:m,name:d,outline:!0}),!0)};return e.jsxs(w,{buttonLabel:"Voronoi",onFormSubmit:i,buttonIcon:e.jsx(Ie,{}),children:["select layer:",e.jsx(C,{selectedLayers:t,setSelectedLayers:o,renderingType:"circle"}),e.jsxs("span",{children:[e.jsx("input",{type:"checkbox",checked:r,onChange:f=>n(f.target.checked),id:"checkboxPropertyEnabled"}),e.jsxs("label",{htmlFor:"checkboxPropertyEnabled",children:["use custom bounding box: ",r]})]}),r&&e.jsx(C,{selectedLayers:l,setSelectedLayers:a}),e.jsx("input",{type:"text",value:d,onChange:f=>u(f.target.value)})]})},We=()=>{const{addLayer:s}=L(),[t,o]=c.useState([]),[r,n]=c.useState("");c.useEffect(()=>{if(t&&t.length>=1){let a=t[0].name;for(let d=1;d<t.length;d++)a+=`, ${t[d].name}`;n(`bbox(${a})`)}},[t]);const l=()=>{if(!t||t.length<1)return alert("Please select one or more layers"),!1;const a=t.flatMap(u=>u.featureCollection.features),d=Ee(F({type:"FeatureCollection",features:a}));return d?(s({featureCollection:{type:"FeatureCollection",features:[d]},name:r}),!0):(alert("No results found"),!1)};return e.jsxs(w,{buttonLabel:"Bbox",onFormSubmit:l,buttonIcon:e.jsx(ue,{}),children:[e.jsx(C,{selectedLayers:t,setSelectedLayers:o,multiple:!0}),e.jsx("input",{type:"text",value:r,onChange:a=>n(a.target.value)})]})},He=()=>{var u;const{addLayer:s}=L(),[t,o]=c.useState([]),[r,n]=c.useState([]),[l,a]=c.useState("");c.useEffect(()=>{t[0]&&r[0]&&a(`clip(${r[0].name}, ${t[0].name})`)},[r,t]);const d=()=>{if(!t[0]||!r[0])return alert("Please select two layers"),!1;let i={type:"FeatureCollection",features:[]};if(r[0].renderingType==="circle")i=Te(r[0].featureCollection,t[0].featureCollection);else if(r[0].renderingType==="fill"){const f=t[0].featureCollection,h=r[0].featureCollection;f.features.forEach(m=>{h.features.forEach(g=>{const v=J({type:"FeatureCollection",features:[g,m]});v&&i.features.push(v)})})}else if(r[0].renderingType==="line"){const f=k(t[0].featureCollection),h=k(r[0].featureCollection);f.features.forEach(m=>{const g=H(m,.01,{units:"meters"});h.features.forEach(v=>{A(v,g)?i.features.push(v):Me(v,m).features.forEach(y=>{A(y,g)&&i.features.push(y)})})})}else throw new Error("Unknown rendering type");return!i||i.features.length===0?(alert("No results found"),!1):(s({featureCollection:i,name:l}),!0)};return e.jsxs(w,{buttonLabel:"Clip",onFormSubmit:d,buttonIcon:e.jsx(de,{}),children:["select layer:",e.jsx(C,{selectedLayers:r,setSelectedLayers:n}),"select mask layer:",e.jsx(C,{selectedLayers:t,setSelectedLayers:o,renderingType:"fill",unselectableLayerIds:[(u=r[0])==null?void 0:u.id]}),e.jsx("input",{type:"text",value:l,onChange:i=>a(i.target.value)})]})},Je=()=>e.jsxs(e.Fragment,{children:[e.jsx(Be,{}),e.jsx(Ae,{}),e.jsx(Ue,{}),e.jsx(ze,{}),e.jsx(qe,{}),e.jsx(Ve,{}),e.jsx(We,{}),e.jsx(He,{})]}),Ge=({setWidth:s,setOpen:t})=>{const{mapRef:o}=P(),r=c.useRef(null),[n,l]=c.useState(!1),a=i=>{l(!0),i.preventDefault(),i.stopPropagation()},d=c.useCallback(()=>{l(!1),setTimeout(()=>{var i;(i=o.current)==null||i.resize()},1),setTimeout(()=>{var i;(i=o.current)==null||i.resize()},100)},[o]),u=c.useCallback(i=>{var f;n&&((f=o.current)==null||f.resize(),s(i.clientX),i.clientX<100?t(!1):t(!0))},[n,o,s,t]);return c.useEffect(()=>(window.addEventListener("mousemove",u),window.addEventListener("mouseup",d),()=>{window.removeEventListener("mousemove",u),window.removeEventListener("mouseup",d)}),[n,u,d]),e.jsx("div",{className:`resizeHandle ${n?"resizing":""}`,onMouseDown:a,ref:r})},Ze=({color:s,onChange:t,layerType:o})=>{const[r,n]=c.useState(!1),l=c.useRef(null);return E(l,()=>{n(!1)}),e.jsxs("div",{className:"colorPicker",ref:l,children:[e.jsxs("button",{type:"button",className:"colorPickerButton",onClick:()=>{n(!r)},style:{color:`hsl(${s.h},${s.s}%,${s.l}%)`},children:[o==="circle"&&e.jsx(Z,{}),o==="line"&&e.jsx(G,{}),o==="fill"&&e.jsx("div",{className:"polygonShrinker",children:e.jsx(K,{})})]}),r&&e.jsx("div",{className:"colorPickerPopover",children:e.jsx(fe,{color:s,onChange:a=>{t(a)}})})]})},Ke=({layerId:s,initialLayerName:t,isEditing:o,setIsEditing:r,closeMenu:n})=>{const{changeLayerName:l}=L(),[a,d]=c.useState(t),u=c.useRef(null);return c.useEffect(()=>{o&&u.current&&u.current.focus()},[o,u]),E(u,()=>{o&&(l(s,a),r(!1),n())}),e.jsx("div",{className:"layerNameContainer",children:o?e.jsx("form",{onSubmit:i=>{i.preventDefault(),l(s,a),r(!1)},children:e.jsx("input",{type:"text",value:a,onChange:i=>d(i.target.value),ref:u,onFocus:()=>r(!0),onBlur:()=>l(s,a)})}):e.jsx("div",{className:"layerName",children:e.jsx("span",{onDoubleClick:()=>r(!0),children:a})})})},X=$(s=>({selectedLayer:[],setSelectedLayer:t=>s(o=>typeof t=="function"?{selectedLayer:t(o.selectedLayer)}:{selectedLayer:t}),tableOpen:!1,setTableOpen:t=>s(()=>({tableOpen:t})),openTableWithLayer:t=>s(()=>({tableOpen:!0,selectedLayer:t}))})),Xe=({layerData:s,layerAboveId:t,index:o})=>{const[r,n]=c.useState(!1),l=c.useRef(null);E(l,()=>{n(!1)});const{deleteLayer:a,toggleLayerVisibility:d,changeLayerColor:u}=L(),{mapRef:i}=P(),{openTableWithLayer:f}=X();c.useEffect(()=>{var p,j,b,S;(p=i.current)!=null&&p.getSource(s.id)||(j=i.current)==null||j.addSource(s.id,{type:"geojson",data:s.featureCollection}),(b=i.current)!=null&&b.getLayer(s.id)||(S=i.current)==null||S.addLayer({id:s.id,type:s.renderingType,source:s.id,paint:s.renderingType==="fill"?{"fill-color":`hsl(${s.color.h},${s.color.s}%,${s.color.l}%)`,"fill-opacity":s.color.a,...s.outline?{"fill-outline-color":"black"}:{}}:s.renderingType==="line"?{"line-color":`hsl(${s.color.h},${s.color.s}%,${s.color.l}%)`,"line-opacity":s.color.a,"line-width":2}:s.renderingType==="circle"?{"circle-color":`hsl(${s.color.h},${s.color.s}%,${s.color.l}%)`,"circle-opacity":s.color.a,"circle-radius":5}:{}})},[i,s]),c.useEffect(()=>{var p;(p=i.current)==null||p.moveLayer(s.id,t)},[t,s.id,i,s.updater]),c.useEffect(()=>{var p;(p=i.current)==null||p.setLayoutProperty(s.id,"visibility",s.visible?"visible":"none")},[s.visible,i,s.id,s.updater]);const h=p=>{var j,b,S,N,T,R;u(s.id,p),s.renderingType==="fill"?((j=i.current)==null||j.setPaintProperty(s.id,"fill-color",`hsl(${p.h},${p.s}%,${p.l}%)`),(b=i.current)==null||b.setPaintProperty(s.id,"fill-opacity",p.a)):s.renderingType==="line"?((S=i.current)==null||S.setPaintProperty(s.id,"line-color",`hsl(${p.h},${p.s}%,${p.l}%)`),(N=i.current)==null||N.setPaintProperty(s.id,"line-opacity",p.a)):s.renderingType==="circle"&&((T=i.current)==null||T.setPaintProperty(s.id,"circle-color",`hsl(${p.h},${p.s}%,${p.l}%)`),(R=i.current)==null||R.setPaintProperty(s.id,"circle-opacity",p.a))},m=()=>{var p,j;(p=i.current)==null||p.removeLayer(s.id),(j=i.current)==null||j.removeSource(s.id),a(s.id)},g=()=>{const p=new Blob([JSON.stringify(s.featureCollection)],{type:"application/geo+json"}),j=URL.createObjectURL(p),b=document.createElement("a");b.href=j,b.download=s.name+".geojson",document.body.appendChild(b),b.click(),document.body.removeChild(b),URL.revokeObjectURL(j)},v=()=>{var j;const p=F(s.featureCollection).slice(0,4);(j=i.current)==null||j.fitBounds(p,{padding:20})},[x,y]=c.useState(!1);return e.jsxs("div",{className:"layerItem",children:[e.jsxs("span",{className:"layerIndex",children:[o+1,"."]}),e.jsx(Ze,{color:s.color,onChange:h,layerType:s.renderingType}),e.jsx(Ke,{layerId:s.id,initialLayerName:s.name,isEditing:x,setIsEditing:y,closeMenu:()=>n(!1)}),e.jsxs("div",{className:`layerMenu ${r?"open":""}`,ref:l,children:[e.jsx("button",{type:"button",onClick:()=>{n(!r)},children:e.jsx(pe,{})}),r&&e.jsx("div",{className:"layerMenuPopover",children:e.jsxs("ul",{children:[e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:m,children:[e.jsx(me,{})," Delete layer"]})}),e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:g,children:[e.jsx(xe,{})," Download layer"]})}),e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:v,children:[e.jsx(he,{})," Zoom to layer"]})}),e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:p=>{p.stopPropagation(),y(!x)},children:[x?e.jsx(je,{}):e.jsx(ye,{})," Edit layer name"]})}),e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:()=>{f([s])},children:[e.jsx(q,{})," Attribute table"]})})]})})]}),e.jsx("button",{type:"button",onClick:()=>d(s.id),children:s.visible?e.jsx(V,{}):e.jsx(W,{})})]})},Qe=()=>{const{layers:s,moveLayerUp:t,moveLayerDown:o}=L(),[r,n]=c.useState(null),[l,a]=c.useState(null);c.useEffect(()=>{r!==null&&a(r)},[r]);const d=(f,h)=>{n(h),f.dataTransfer.setDragImage(new Image,0,0)},u=(f,h)=>{f.preventDefault(),f.dataTransfer.dropEffect="move",!(r===null||r===h)&&(s.findIndex(m=>m.id===r)<s.findIndex(m=>m.id===h)?o(r):t(r))},i=()=>{n(null)};return e.jsx("ol",{className:"layerList",children:s.map((f,h)=>e.jsx("li",{draggable:!0,className:`layerListItem ${l===f.id?"hovering":""}`,onDragStart:m=>d(m,f.id),onDragOver:m=>u(m,f.id),onDragEnd:i,onMouseOver:()=>r===null?a(f.id):void 0,onMouseOut:()=>r===null?a(null):void 0,children:e.jsx(Xe,{layerData:f,layerAboveId:h===0?void 0:s[h-1].id,index:h})},f.id))})},Ye=()=>{const{selectedLayer:s,setSelectedLayer:t,tableOpen:o,setTableOpen:r}=X(),[n,l]=c.useState([]);c.useEffect(()=>{l(s.length>0?s[0].featureCollection.features.map((x,y)=>{const p={...x.properties||{},mugisSelected:!1,mugisIndex:y};return{...x,properties:p}}):[])},[s]);const a=c.useMemo(()=>{const x=new Set;return n.forEach(y=>{y&&y.properties&&Object.keys(y.properties).forEach(p=>x.add(p))}),x.delete("mugisSelected"),x.delete("mugisIndex"),Array.from(x)},[n]),[d,u]=c.useState(null),[i,f]=c.useState(!0),h=c.useMemo(()=>d?[...n].sort((x,y)=>{const p=x&&x.properties&&d in x.properties?x.properties[d]??"":"",j=y&&y.properties&&d in y.properties?y.properties[d]??"":"";return p===j?0:p===void 0?1:j===void 0?-1:p<j?i?-1:1:p>j?i?1:-1:0}):n,[n,d,i]),m=x=>{d===x?i?f(!1):u(null):(u(x),f(!0))},{addLayer:g}=L(),v=()=>{if(s.length===0||n.length===0)return;const x=n.filter(y=>{var p;return(p=y.properties)==null?void 0:p.mugisSelected}).map(y=>({...y,properties:{...y.properties,mugisSelected:void 0,mugisIndex:void 0}}));x.length!==0&&(g({featureCollection:{type:"FeatureCollection",features:x},name:`selection(${s[0].name})`,outline:s[0].outline}),r(!1))};return e.jsxs("div",{children:[e.jsx("button",{type:"button",className:"toolButton",onClick:()=>r(!o),children:e.jsx(q,{})}),o&&e.jsx("div",{className:"cover",onClick:x=>{x.target===x.currentTarget&&r(!1)},children:e.jsxs("div",{className:"attributeTable",children:[e.jsx("button",{type:"button",className:"modalCloseButton",onClick:()=>r(!1),children:e.jsx(z,{})}),e.jsx("h3",{children:"Attribute Table"}),e.jsx(C,{selectedLayers:s,setSelectedLayers:t}),e.jsx("button",{type:"button",onClick:v,children:"Create Layer From Selection"}),e.jsx("div",{className:"tableContainer",children:s.length>0&&e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:e.jsx("button",{type:"button",className:"selectAll",onClick:()=>{n.every(x=>{var y;return!((y=x.properties)!=null&&y.mugisSelected)})?l(x=>x.map(y=>{const p={...y.properties||{},mugisSelected:!0};return{...y,properties:p}})):l(x=>x.map(y=>{const p={...y.properties||{},mugisSelected:!1};return{...y,properties:p}}))},children:n.every(x=>x.properties.mugisSelected)?e.jsx(O,{}):n.every(x=>!x.properties.mugisSelected)?e.jsx(I,{}):e.jsx(be,{})})}),a.map((x,y)=>e.jsx("th",{children:e.jsxs("button",{type:"button",onClick:()=>m(x),children:[x,e.jsx("div",{className:"sortIcon",children:d===x&&(i?e.jsx(ge,{}):e.jsx(ve,{}))})]})},y))]})}),e.jsx("tbody",{children:h.map((x,y)=>{var p;return e.jsxs("tr",{className:(p=x.properties)!=null&&p.mugisSelected?"selected":"",children:[e.jsx("td",{children:e.jsx("button",{type:"button",onClick:()=>{l(j=>j.map((b,S)=>{var N,T;if(S===((N=x.properties)==null?void 0:N.mugisIndex)){const R={...b.properties||{},mugisSelected:!((T=b.properties)!=null&&T.mugisSelected)};return{...b,properties:R}}return b}))},children:x.properties.mugisSelected?e.jsx(O,{}):e.jsx(I,{})})}),a.map((j,b)=>e.jsx("td",{children:x.properties?x.properties[j]:""},b))]},y)})})]})})]})})]})},_e=({handleLoadFileInput:s})=>{const[t,o]=c.useState(!0),[r,n]=c.useState(300),{layers:l,toggleLayerVisibilityAll:a}=L(),{mapRef:d,mapReady:u}=P();c.useEffect(()=>{const h=setInterval(()=>{var m;(m=d.current)==null||m.resize()},1);setTimeout(()=>{clearInterval(h)},1)},[d,t]);const i=c.useRef(null),f=()=>{i.current&&i.current.click()};return e.jsxs("div",{className:`sidebarContainer ${t?"open":""}`,children:[e.jsx(Ge,{setWidth:n,setOpen:o}),e.jsxs("aside",{className:"sidebar",style:{width:`${r}px`},children:[e.jsxs("div",{className:"sidebarHeader",children:[e.jsx("h2",{children:"Layers"}),e.jsxs("div",{className:"sidebarHeaderActions",children:[e.jsx(Ye,{}),e.jsx("button",{type:"button",onClick:a,children:l.every(h=>h.visible)?e.jsx(V,{}):e.jsx(W,{})})]})]}),e.jsx("div",{className:"layerListContainer",children:u&&e.jsx(Qe,{})}),e.jsxs("div",{className:"sidebarFooter",children:[e.jsxs("button",{type:"button",onClick:f,children:[e.jsx(Le,{})," Upload GeoJSON file"]}),e.jsx("input",{ref:i,type:"file",multiple:!0,accept:".geojson",onChange:s})]})]})]})};function De(){const{addLayer:s}=L(),t=n=>{if(!n){console.log("no file selected");return}Array.from(n).forEach(l=>{const a=new FileReader;a.onload=d=>{var u;try{const i=JSON.parse((u=d.target)==null?void 0:u.result);if(i.type!=="FeatureCollection")throw new Error("Not a valid GeoJSON file, must be a FeatureCollection");s({featureCollection:i,name:l.name})}catch(i){console.log(i)}},a.readAsText(l)})},o=n=>{t(n.target.files),n.target.value=""},r=n=>{n.preventDefault(),t(n.dataTransfer.files)};return e.jsxs("div",{className:"pageContainer",onDragOver:n=>n.preventDefault(),onDrop:r,children:[e.jsxs("header",{className:"mainHeader",children:[e.jsx("h1",{children:"μGIS"}),e.jsx(Je,{}),e.jsx(Oe,{})]}),e.jsxs("main",{className:"mainContainer",children:[e.jsx(_e,{handleLoadFileInput:o}),e.jsx("div",{className:"mapFlexContainer",children:e.jsx(Re,{})})]})]})}Ce.createRoot(document.getElementById("root")).render(e.jsx(c.StrictMode,{children:e.jsx(De,{})}));
