import{e as W,f as u,j as e,M as oe,S as le,F as ie,h as ae,k as ce,l as ue,m as de,G as pe,X,n as fe,C as me,o as he,q as xe,t as ye,w as je,x as be,y as ge,z as ve,E as Ce,T as Y,A as Se,Z as Le,P as Ne,B as we,D as Q,H as _,I as D,J as ke,K as Pe,L as Ee,N as H,O as J,Q as Fe,U as Te,V as Oe,W as $e,Y as Me}from"./vendor-D5kv5bbM.js";import{m as A,M as Re}from"./vendor-mapbox-DnrUL6bs.js";import{b as ee,i as te,u as Ie,c as Be,d as Ae,a as G,f as M,v as Ue,e as z,g as Ve,p as We,h as Z,l as ze}from"./vendor-turf-DQpktr1_.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function l(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=l(n);fetch(n.href,o)}})();const R=W(r=>({mapRef:u.createRef(),setMapRef:t=>r({mapRef:t}),mapReady:!1,setMapReady:t=>r({mapReady:t}),basemap:{url:"mapbox://styles/mapbox/streets-v12",name:"Streets"},setBasemap:t=>r(l=>t.url===l.basemap.url?l:{basemap:t}),resetMapStore:()=>r(()=>({mapReady:!1,basemap:{url:"mapbox://styles/mapbox/streets-v12",name:"Streets"}}))})),w=W(r=>({layers:[],resetLayerStore:()=>r(()=>({layers:[]})),loadProjectLayers:t=>r(()=>({layers:t})),addLayer:t=>r(l=>{const s=c=>l.layers.some(a=>a.id===c)?s(c+"1"):c,n=t.featureCollection.features[0].geometry.type;t.featureCollection.features.forEach(c=>{if(c.geometry.type!==n)throw new Error(`All features must have the same geometry type, found both ${n} and ${c.geometry.type}`)});const o=n==="Polygon"||n==="MultiPolygon"?"fill":n==="LineString"||n==="MultiLineString"?"line":n==="Point"||n==="MultiPoint"?"circle":null;if(!o)throw new Error("Unsupported geometry type: "+n);t.name||(t.name=o==="fill"?"polygon":o==="line"?"line":o==="circle"?"point":"not possible");const i={h:Math.floor(Math.random()*360),s:90,l:48,a:o==="fill"?.7:1};return{layers:[{featureCollection:t.featureCollection,id:s(t.name),name:t.name,renderingType:o,visible:!0,color:i,outline:t.outline},...l.layers]}}),moveLayerUp:t=>r(l=>{const s=l.layers.findIndex(o=>o.id===t);if(s===0)return l;const n=[...l.layers];return n.splice(s-1,0,n.splice(s,1)[0]),{layers:n}}),moveLayerDown:t=>r(l=>{const s=l.layers.findIndex(o=>o.id===t);if(s===l.layers.length-1)return l;const n=[...l.layers];return n.splice(s+1,0,n.splice(s,1)[0]),{layers:n}}),deleteLayer:t=>r(l=>({layers:l.layers.filter(s=>s.id!==t)})),toggleLayerVisibility:t=>r(l=>({layers:l.layers.map(s=>s.id===t?{...s,visible:!s.visible}:s)})),toggleLayerVisibilityAll:()=>r(t=>{const l=t.layers.every(s=>s.visible);return{layers:t.layers.map(s=>({...s,visible:!l}))}}),changeLayerColor:(t,l)=>r(s=>({layers:s.layers.map(n=>n.id===t?{...n,color:l}:n)})),updateAllLayers:()=>r(t=>({layers:t.layers.map(l=>({...l,updater:l.updater?l.updater+1:1}))})),changeLayerName:(t,l)=>r(s=>({layers:s.layers.map(n=>n.id===t?{...n,name:l}:n)}))}));A.accessToken="pk.eyJ1IjoidG9iaWFuZCIsImEiOiJjbTdiMGZwemwwNmxlMnFyNTV4YWh2ZzB3In0.B3fVZMQOYEs2V23kKWB5XQ";const qe=()=>{const{mapRef:r,mapReady:t,setMapReady:l,basemap:s}=R(),{addLayer:n,updateAllLayers:o}=w(),i=u.useRef(null);u.useEffect(()=>{var m,C,v,k,L,y;if(!t&&i.current){i.current.innerHTML="",r.current=new A.Map({container:i.current,style:s.url,center:[10.4,63.425],zoom:12}),(m=r.current)==null||m.addControl(new A.FullscreenControl,"top-right"),(C=r.current)==null||C.addControl(new A.NavigationControl({visualizePitch:!0}),"top-right"),(v=r.current)==null||v.addControl(new A.ScaleControl,"bottom-right");const b=new Re({displayControlsDefault:!1,controls:{point:!0,line_string:!0,polygon:!0},boxSelect:!1});(k=r.current)==null||k.addControl(b,"bottom-left"),(L=r.current)==null||L.on("draw.create",()=>{n({featureCollection:b.getAll(),name:null}),b.deleteAll()}),(y=r.current)==null||y.on("style.load",()=>{l(!0)})}},[r,n,t,l,s]);const[d,c]=u.useState(!1),a=u.useRef(s),[p,h]=u.useState(s);return u.useEffect(()=>{var m;a.current.url!==s.url&&(a.current=s),!d&&p.url!==a.current.url&&(c(!0),t&&r.current&&(r.current.setStyle(a.current.url),h(s)),(m=r.current)==null||m.once("style.load",()=>{o()}),setTimeout(()=>{c(!1)},200))},[s,r,t,d,p,o]),e.jsx("div",{ref:i,className:"mapContainer"})},I=(r,t,l=[])=>{u.useEffect(()=>{const s=n=>{const o=n.target;r.current&&!r.current.contains(o)&&!l.some(i=>{var d;return(d=i.current)==null?void 0:d.contains(o)})&&t()};return document.addEventListener("click",s),()=>{document.removeEventListener("click",s)}},[r,t,l])},He=()=>{const[r,t]=u.useState(!1),l=u.useRef(null);I(l,()=>{t(!1)});const[s,n]=u.useState(null),{basemap:o,setBasemap:i}=R(),d=[{url:"mapbox://styles/mapbox/streets-v12",name:"Streets"},{url:"mapbox://styles/mapbox/outdoors-v12",name:"Outdoors"},{url:"mapbox://styles/mapbox/light-v11",name:"Light"},{url:"mapbox://styles/mapbox/dark-v11",name:"Dark"},{url:"mapbox://styles/mapbox/satellite-v9",name:"Satellite"},{url:"mapbox://styles/mapbox/satellite-streets-v12",name:"Satellite Streets"},{url:"mapbox://styles/mapbox/navigation-day-v1",name:"Navigation Day"},{url:"mapbox://styles/mapbox/navigation-night-v1",name:"Navigation Night"},{url:"mapbox://styles/tobiand/cm8rbg7j900be01sa5wc6d4lq",name:"Off (white)"},{url:"mapbox://styles/tobiand/cm8rbd89l00az01sb97a8hfyh",name:"Off (black)"}];return e.jsxs("div",{className:"basemap",ref:l,children:[e.jsxs("button",{type:"button",onClick:()=>t(!r),children:[e.jsx(oe,{})," Change basemap"]}),r&&e.jsx("div",{className:"basemapPopover",children:e.jsx("ul",{onMouseEnter:()=>{n(o)},onMouseLeave:()=>{i(s),n(null)},children:d.map(c=>e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:()=>{n(c)},onMouseEnter:()=>{i(c)},children:[s===null&&c.name===o.name||s!==null&&c.name===s.name?"*":"",c.name]})},c.name))})})]})},Je=W(r=>({theme:localStorage.getItem("theme")||"light",setTheme:t=>r(l=>(localStorage.setItem("theme",t),t===l.theme?l:{theme:t}))})),Ge=()=>{const[r,t]=u.useState(!1),l=u.useRef(null);I(l,()=>{t(!1)});const{layers:s,resetLayerStore:n,loadProjectLayers:o}=w(),{basemap:i,setBasemap:d,resetMapStore:c}=R(),{theme:a,setTheme:p}=Je(),h=()=>{n(),c()},m=()=>{const L={layers:s,basemap:i},y=new Blob([JSON.stringify(L)],{type:"application/json"}),b=URL.createObjectURL(y),S=document.createElement("a");S.href=b,S.download="μGIS_project.mugis",document.body.appendChild(S),S.click(),document.body.removeChild(S),URL.revokeObjectURL(b)},C=u.useRef(null),v=()=>{var L;(L=C.current)==null||L.click()},k=L=>{const y=L.target.files;if(!y){console.log("no file selected");return}const b=new FileReader;b.onload=S=>{var f;try{const x=JSON.parse((f=S.target)==null?void 0:f.result);o(x.layers),d(x.basemap)}catch(x){console.log(x)}},b.readAsText(y[0])};return u.useEffect(()=>{document.documentElement.setAttribute("data-theme",a)},[a]),e.jsxs("div",{className:"settings",ref:l,children:[e.jsx("button",{type:"button",onClick:()=>{t(!r)},children:e.jsx(le,{})}),r&&e.jsx("div",{className:"settingsPopover",children:e.jsxs("ul",{children:[e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:h,children:[e.jsx(ie,{})," New project"]})}),e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:m,children:[e.jsx(ae,{})," Save project"]})}),e.jsxs("li",{children:[e.jsx("input",{ref:C,type:"file",accept:".mugis",onChange:k}),e.jsxs("button",{type:"button",onClick:v,children:[e.jsx(ce,{})," Load project"]})]}),e.jsx("li",{children:e.jsx(He,{})}),e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:L=>{L.stopPropagation(),p(a==="light"?"dark":"light")},children:[a==="light"?e.jsx(ue,{}):e.jsx(de,{})," Toggle theme"]})}),e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:()=>{},children:[e.jsx(pe,{})," Start tutorial"]})})]})})]})},O=({children:r,buttonLabel:t,onFormSubmit:l,buttonIcon:s})=>{const[n,o]=u.useState(!1),[i,d]=u.useState(!1);return e.jsxs("div",{children:[e.jsxs("button",{type:"button",className:"toolButton",onClick:()=>o(!n),children:[s," ",t]}),n&&e.jsx("div",{className:"cover",onClick:c=>{c.target===c.currentTarget&&o(!1)},children:e.jsx("div",{className:"modal"+(i?" loading":""),children:e.jsxs("form",{onSubmit:c=>{c.preventDefault(),d(!0),setTimeout(()=>{l()&&o(!1),d(!1)},0)},children:[e.jsx("button",{type:"button",className:"modalCloseButton",onClick:()=>o(!1),children:e.jsx(X,{})}),e.jsx("h3",{children:t}),r,e.jsx("button",{type:"submit",children:"Submit"})]})})})]})};function re({size:r=120}){return e.jsxs("svg",{width:r,height:r,viewBox:"0 0 120 120",version:"1.1",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{style:{fill:"none",stroke:"currentColor",strokeWidth:16,strokeLinejoin:"round",strokeOpacity:1},d:"M 15,55 50,80 70,40 105,65"}),e.jsx("circle",{cx:"15",cy:"55",r:"12",fill:"currentColor"}),e.jsx("circle",{cx:"50",cy:"80",r:"12",fill:"currentColor"}),e.jsx("circle",{cx:"70",cy:"40",r:"12",fill:"currentColor"}),e.jsx("circle",{cx:"105",cy:"65",r:"12",fill:"currentColor"})]})}function se({size:r=120}){return e.jsx("svg",{width:r,height:r,viewBox:"0 0 120 120",version:"1.1",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("circle",{cx:"60",cy:"60",r:"25",fill:"currentColor"})})}function ne({size:r=120}){return e.jsxs("svg",{width:r,height:r,viewBox:"0 0 120 120",version:"1.1",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{style:{fill:"currentColor",stroke:"currentColor",strokeWidth:16,strokeLinejoin:"round",strokeOpacity:1,fillOpacity:.5},d:"M 60,17 100,48 88,95 H 32 L 20,48 60,17"}),e.jsx("circle",{cx:"60",cy:"17",r:"12",fill:"currentColor"}),e.jsx("circle",{cx:"100",cy:"48",r:"12",fill:"currentColor"}),e.jsx("circle",{cx:"88",cy:"95",r:"12",fill:"currentColor"}),e.jsx("circle",{cx:"32",cy:"95",r:"12",fill:"currentColor"}),e.jsx("circle",{cx:"20",cy:"48",r:"12",fill:"currentColor"})]})}function Ze(){return e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{width:"20",height:"20",x:"2",y:"2",rx:"2"}),e.jsx("circle",{cx:"7",cy:"9",r:"1"}),e.jsx("circle",{cx:"9",cy:"17",r:"1"}),e.jsx("circle",{cx:"17",cy:"10",r:"1"}),e.jsx("line",{x1:"11.7436",y1:"12.0641",x2:"19.5625",y2:"21"}),e.jsx("line",{x1:"11.7436",y1:"12.0641",x2:"12.65",y2:"3"}),e.jsx("line",{x1:"11.7436",y1:"12.0641",x2:"3",y2:"14.25"})]})}const K=({name:r,type:t,index:l,color:s,onRemove:n})=>e.jsxs("div",{className:"layerItem",children:[e.jsxs("span",{className:"layerIndex",children:[l+1,"."]}),e.jsxs("div",{className:"colorPickerButton",style:{color:`hsl(${s.h},${s.s}%,${s.l}%)`},children:[t==="circle"&&e.jsx(se,{}),t==="line"&&e.jsx(re,{}),t==="fill"&&e.jsx("div",{className:"polygonShrinker",children:e.jsx(ne,{})})]}),e.jsx("div",{className:"layerName",children:e.jsx("span",{children:r})}),n&&e.jsx("button",{type:"button",onClick:o=>{n(),o.stopPropagation()},children:e.jsx(fe,{})})]}),F=({selectedLayers:r,setSelectedLayers:t,renderingType:l=void 0,multiple:s=!1,unselectableLayerIds:n=[]})=>{const{layers:o}=w(),[i,d]=u.useState(!1),c=u.useRef(null),a=u.useRef(null);return I(c,()=>{d(!1)}),u.useEffect(()=>{var p,h,m,C,v,k;c.current&&a.current&&((h=a.current)==null||h.style.setProperty("max-height",`${window.innerHeight-((p=c.current)==null?void 0:p.getBoundingClientRect().bottom)-10}px`),(C=a.current)==null||C.style.setProperty("width",`${(m=c.current)==null?void 0:m.getBoundingClientRect().width}px`),(k=a.current)==null||k.style.setProperty("top",`${((v=c.current)==null?void 0:v.getBoundingClientRect().bottom)+window.scrollY}px`))},[i,r]),u.useEffect(()=>{r.forEach(p=>{n.includes(p.id)&&t(h=>h.filter(m=>m.id!==p.id))})},[n,r,t]),e.jsxs("div",{className:"selectLayersContainer",ref:c,onClick:()=>{d(!i)},children:[e.jsx("ol",{className:"selectedList",children:r.length===0?e.jsx("p",{children:"No layer selected"}):o.map((p,h)=>l&&p.renderingType!==l||!r.some(m=>m.id===p.id)?null:e.jsx("li",{children:e.jsx(K,{name:p.name,type:p.renderingType,index:h,color:p.color,onRemove:()=>{t(m=>m.filter(C=>C.id!==p.id))}})},p.id))}),i&&e.jsxs("div",{className:"selectListContainer",onClick:p=>{s&&p.stopPropagation()},ref:a,children:[e.jsx("h4",{children:"Select Layers"}),e.jsx("ol",{className:"selectList",children:o.map((p,h)=>l&&p.renderingType!==l||r.some(m=>m.id===p.id)||n.includes(p.id)?null:e.jsx("li",{className:"selectListItem",onClick:()=>{t(s?m=>[...m,p]:[p])},children:e.jsx(K,{name:p.name,type:p.renderingType,index:h,color:p.color})},p.id))||e.jsx("p",{children:"No layers available"})})]})]})},Ke=()=>{const{addLayer:r}=w(),[t,l]=u.useState([]),[s,n]=u.useState(""),[o,i]=u.useState("");u.useEffect(()=>{t[0]&&i(`buffer(${t[0].name}, ${s}m)`)},[t,s]);const d=()=>{if(!t[0]||s==="")return alert("Please select a layer and enter a radius"),!1;const c=t[0].featureCollection,a=ee(c,s*.001,{units:"kilometers"});return!a||a.features.length===0?(alert("No results found"),!1):(r({featureCollection:a,name:o}),!0)};return e.jsxs(O,{buttonLabel:"Buffer",onFormSubmit:d,buttonIcon:e.jsx(me,{}),children:[e.jsx(F,{selectedLayers:t,setSelectedLayers:l}),"buffer radius [m]: ",s,e.jsx("input",{type:"number",value:s,onChange:c=>n(c.target.value)}),e.jsx("input",{type:"text",value:o,onChange:c=>i(c.target.value)})]})},Xe=()=>{const{addLayer:r}=w(),[t,l]=u.useState([]),[s,n]=u.useState("");u.useEffect(()=>{if(t&&t.length>=2){let i=t[0].name;for(let d=1;d<t.length;d++)i+=`, ${t[d].name}`;n(`intersect(${i})`)}},[t]);const o=()=>{if(!t||t.length<2)return alert("Please select two layers"),!1;const i={type:"FeatureCollection",features:t[0].featureCollection.features};for(let d=1;d<t.length;d++){const c=t[d].featureCollection,a=[];i.features.forEach(p=>{c.features.forEach(h=>{const m=te({type:"FeatureCollection",features:[p,h]});m&&a.push(m)})}),i.features=a}return!i||i.features.length===0?(alert("No results found"),!1):(r({featureCollection:i,name:s}),!0)};return e.jsxs(O,{buttonLabel:"Intersect",onFormSubmit:o,buttonIcon:e.jsx(he,{}),children:[e.jsx(F,{selectedLayers:t,setSelectedLayers:l,renderingType:"fill",multiple:!0}),e.jsx("input",{type:"text",value:s,onChange:i=>n(i.target.value)})]})},Ye=()=>{const{addLayer:r}=w(),[t,l]=u.useState([]),[s,n]=u.useState("");u.useEffect(()=>{if(t&&t.length>=2){let i=t[0].name;for(let d=1;d<t.length;d++)i+=`, ${t[d].name}`;n(`union(${i})`)}},[t]);const o=()=>{if(!t||t.length<2)return alert("Please select two layers"),!1;const i=t.flatMap(c=>c.featureCollection.features),d=Ie({type:"FeatureCollection",features:i});return d?(r({featureCollection:{type:"FeatureCollection",features:[d]},name:s}),!0):(alert("No results found"),!1)};return e.jsxs(O,{buttonLabel:"Union",onFormSubmit:o,buttonIcon:e.jsx(xe,{}),children:[e.jsx(F,{selectedLayers:t,setSelectedLayers:l,renderingType:"fill",multiple:!0}),e.jsx("input",{type:"text",value:s,onChange:i=>n(i.target.value)})]})},Qe=()=>{var c;const{addLayer:r}=w(),[t,l]=u.useState([]),[s,n]=u.useState([]),[o,i]=u.useState("");u.useEffect(()=>{t[0]&&s[0]&&i(`difference(${t[0].name}, ${s[0].name})`)},[t,s]);const d=()=>{if(!t[0]||!s[0])return alert("Please select two layers"),!1;const a={type:"FeatureCollection",features:[]},p=t[0].featureCollection,h=s[0].featureCollection,m=Be(h).features[0];return p.features.forEach(C=>{const v=Ae({type:"FeatureCollection",features:[C,m]});v&&a.features.push(v)}),!a||a.features.length===0?(alert("No results found"),!1):(r({featureCollection:a,name:o}),!0)};return e.jsxs(O,{buttonLabel:"Difference",onFormSubmit:d,buttonIcon:e.jsx(ye,{}),children:["select base layer:",e.jsx(F,{selectedLayers:t,setSelectedLayers:l,renderingType:"fill"}),"select layer to subtract:",e.jsx(F,{selectedLayers:s,setSelectedLayers:n,renderingType:"fill",unselectableLayerIds:[(c=t[0])==null?void 0:c.id]}),e.jsx("input",{type:"text",value:o,onChange:a=>i(a.target.value)})]})},_e=()=>{var p;const{addLayer:r}=w(),[t,l]=u.useState([]),[s,n]=u.useState(!1),[o,i]=u.useState(void 0),[d,c]=u.useState("");u.useEffect(()=>{t[0]&&c(s&&o?`dissolve(${t[0].name}, ${o})`:`dissolve(${t[0].name})`)},[t,s,o]);const a=()=>{if(!t[0])return alert("Please select a layer"),!1;const h=t[0].featureCollection,m=s&&o?G(M(h),{propertyName:o}):G(M(h));return!m||m.features.length===0?(alert("No results found"),!1):(r({featureCollection:m,name:d}),!0)};return e.jsxs(O,{buttonLabel:"Dissolve",onFormSubmit:a,buttonIcon:e.jsx(je,{}),children:["select layer:",e.jsx(F,{selectedLayers:t,setSelectedLayers:l,renderingType:"fill"}),e.jsxs("span",{children:[e.jsx("input",{type:"checkbox",checked:s,onChange:h=>n(h.target.checked),id:"checkboxPropertyEnabled"}),e.jsxs("label",{htmlFor:"checkboxPropertyEnabled",children:["dissolve by property: ",s&&o]})]}),e.jsxs("select",{required:!0,disabled:!s,value:o,onChange:h=>i(h.target.value),children:[e.jsx("option",{value:"",children:"Select a property"}),((p=t[0])==null?void 0:p.featureCollection.features[0].properties)&&Object.keys(t[0].featureCollection.features[0].properties).map(h=>e.jsx("option",{value:h,children:h},h))]}),e.jsx("input",{type:"text",value:d,onChange:h=>c(h.target.value)})]})},De=()=>{const{addLayer:r}=w(),[t,l]=u.useState([]),[s,n]=u.useState(!1),[o,i]=u.useState([]),[d,c]=u.useState("");u.useEffect(()=>{t[0]&&(s&&o[0]?c(`voronoi(${t[0].name}, ${o[0].name})`):c(`voronoi(${t[0].name})`))},[t,o,s]);const a=()=>{if(!t[0])return alert("Please select a layer"),!1;const p=M(t[0].featureCollection),h=s&&o[0]?M(o[0].featureCollection):p,m=Ue(p,{bbox:z(h)});return!m||m.features.length===0?(alert("No results found"),!1):(m.features=m.features.filter(C=>C.geometry.type==="Polygon"),r({featureCollection:m,name:d,outline:!0}),!0)};return e.jsxs(O,{buttonLabel:"Voronoi",onFormSubmit:a,buttonIcon:e.jsx(Ze,{}),children:["select layer:",e.jsx(F,{selectedLayers:t,setSelectedLayers:l,renderingType:"circle"}),e.jsxs("span",{children:[e.jsx("input",{type:"checkbox",checked:s,onChange:p=>n(p.target.checked),id:"checkboxPropertyEnabled"}),e.jsxs("label",{htmlFor:"checkboxPropertyEnabled",children:["use custom bounding box: ",s]})]}),s&&e.jsx(F,{selectedLayers:o,setSelectedLayers:i}),e.jsx("input",{type:"text",value:d,onChange:p=>c(p.target.value)})]})},et=()=>{const{addLayer:r}=w(),[t,l]=u.useState([]),[s,n]=u.useState("");u.useEffect(()=>{if(t&&t.length>=1){let i=t[0].name;for(let d=1;d<t.length;d++)i+=`, ${t[d].name}`;n(`bbox(${i})`)}},[t]);const o=()=>{if(!t||t.length<1)return alert("Please select one or more layers"),!1;const i=t.flatMap(c=>c.featureCollection.features),d=Ve(z({type:"FeatureCollection",features:i}));return d?(r({featureCollection:{type:"FeatureCollection",features:[d]},name:s}),!0):(alert("No results found"),!1)};return e.jsxs(O,{buttonLabel:"Bbox",onFormSubmit:o,buttonIcon:e.jsx(be,{}),children:[e.jsx(F,{selectedLayers:t,setSelectedLayers:l,multiple:!0}),e.jsx("input",{type:"text",value:s,onChange:i=>n(i.target.value)})]})},tt=()=>{var c;const{addLayer:r}=w(),[t,l]=u.useState([]),[s,n]=u.useState([]),[o,i]=u.useState("");u.useEffect(()=>{t[0]&&s[0]&&i(`clip(${s[0].name}, ${t[0].name})`)},[s,t]);const d=()=>{if(!t[0]||!s[0])return alert("Please select two layers"),!1;let a={type:"FeatureCollection",features:[]};if(s[0].renderingType==="circle")a=We(s[0].featureCollection,t[0].featureCollection);else if(s[0].renderingType==="fill"){const p=t[0].featureCollection,h=s[0].featureCollection;p.features.forEach(m=>{h.features.forEach(C=>{const v=te({type:"FeatureCollection",features:[C,m]});v&&a.features.push(v)})})}else if(s[0].renderingType==="line"){const p=M(t[0].featureCollection),h=M(s[0].featureCollection);p.features.forEach(m=>{const C=ee(m,.01,{units:"meters"});h.features.forEach(v=>{Z(v,C)?a.features.push(v):ze(v,m).features.forEach(L=>{Z(L,C)&&a.features.push(L)})})})}else throw new Error("Unknown rendering type");return!a||a.features.length===0?(alert("No results found"),!1):(r({featureCollection:a,name:o}),!0)};return e.jsxs(O,{buttonLabel:"Clip",onFormSubmit:d,buttonIcon:e.jsx(ge,{}),children:["select layer:",e.jsx(F,{selectedLayers:s,setSelectedLayers:n}),"select mask layer:",e.jsx(F,{selectedLayers:t,setSelectedLayers:l,renderingType:"fill",unselectableLayerIds:[(c=s[0])==null?void 0:c.id]}),e.jsx("input",{type:"text",value:o,onChange:a=>i(a.target.value)})]})},rt=()=>e.jsxs(e.Fragment,{children:[e.jsx(Ke,{}),e.jsx(Xe,{}),e.jsx(Ye,{}),e.jsx(Qe,{}),e.jsx(_e,{}),e.jsx(De,{}),e.jsx(et,{}),e.jsx(tt,{})]}),st=({setWidth:r,setOpen:t})=>{const{mapRef:l}=R(),s=u.useRef(null),[n,o]=u.useState(!1),i=a=>{o(!0),a.preventDefault(),a.stopPropagation()},d=u.useCallback(()=>{o(!1),setTimeout(()=>{var a;(a=l.current)==null||a.resize()},1),setTimeout(()=>{var a;(a=l.current)==null||a.resize()},100)},[l]),c=u.useCallback(a=>{var p;n&&((p=l.current)==null||p.resize(),r(a.clientX),a.clientX<100?t(!1):t(!0))},[n,l,r,t]);return u.useEffect(()=>(window.addEventListener("mousemove",c),window.addEventListener("mouseup",d),()=>{window.removeEventListener("mousemove",c),window.removeEventListener("mouseup",d)}),[n,c,d]),e.jsx("div",{className:`resizeHandle ${n?"resizing":""}`,onMouseDown:i,ref:s})},nt=({color:r,onChange:t,layerType:l})=>{const[s,n]=u.useState(!1),o=u.useRef(null);return I(o,()=>{n(!1)}),e.jsxs("div",{className:"colorPicker",ref:o,children:[e.jsxs("button",{type:"button",className:"colorPickerButton",onClick:()=>{n(!s)},style:{color:`hsl(${r.h},${r.s}%,${r.l}%)`},children:[l==="circle"&&e.jsx(se,{}),l==="line"&&e.jsx(re,{}),l==="fill"&&e.jsx("div",{className:"polygonShrinker",children:e.jsx(ne,{})})]}),s&&e.jsx("div",{className:"colorPickerPopover",children:e.jsx(ve,{color:r,onChange:i=>{t(i)}})})]})},ot=({layerId:r,initialLayerName:t,isEditing:l,setIsEditing:s,closeMenu:n})=>{const{changeLayerName:o}=w(),[i,d]=u.useState(t),c=u.useRef(null);return u.useEffect(()=>{l&&c.current&&c.current.focus()},[l,c]),I(c,()=>{l&&(o(r,i),s(!1),n())}),e.jsx("div",{className:"layerNameContainer",children:l?e.jsx("form",{onSubmit:a=>{a.preventDefault(),o(r,i),s(!1)},children:e.jsx("input",{type:"text",value:i,onChange:a=>d(a.target.value),ref:c,onFocus:()=>s(!0),onBlur:()=>o(r,i)})}):e.jsx("div",{className:"layerName",children:e.jsx("span",{onDoubleClick:()=>s(!0),children:i})})})},lt=["=","!=","<","<=",">",">="],it=["=","!=","contains","does not contain","starts with","does not start with","ends with","does not end with"],V={active:!1,attribute:"",attributeType:"string",operator:"=",value:""},q=W(r=>({selectedLayer:[],setSelectedLayer:t=>r(l=>typeof t=="function"?{selectedLayer:t(l.selectedLayer)}:{selectedLayer:t}),tableOpen:!1,setTableOpen:t=>r(()=>({tableOpen:t})),openTableWithLayer:t=>r(()=>({tableOpen:!0,selectedLayer:t})),filters:[{...V}],resetFilters:()=>r(()=>({filters:[{...V}]})),addFilter:()=>r(t=>{const l={...V};return{filters:[...t.filters,l]}}),removeFilter:t=>r(l=>{const s=[...l.filters];return s.splice(t,1),s.length===0&&s.push({...V}),{filters:s}}),updateFilter:(t,l)=>r(s=>{const n=[...s.filters];return n[t]=l,{filters:n}})})),at=({layerData:r,layerAboveId:t,index:l})=>{const[s,n]=u.useState(!1),o=u.useRef(null);I(o,()=>{n(!1)});const{deleteLayer:i,toggleLayerVisibility:d,changeLayerColor:c}=w(),{mapRef:a}=R(),{openTableWithLayer:p}=q();u.useEffect(()=>{var y,b,S,f;(y=a.current)!=null&&y.getSource(r.id)||(b=a.current)==null||b.addSource(r.id,{type:"geojson",data:r.featureCollection}),(S=a.current)!=null&&S.getLayer(r.id)||(f=a.current)==null||f.addLayer({id:r.id,type:r.renderingType,source:r.id,paint:r.renderingType==="fill"?{"fill-color":`hsl(${r.color.h},${r.color.s}%,${r.color.l}%)`,"fill-opacity":r.color.a,...r.outline?{"fill-outline-color":"black"}:{}}:r.renderingType==="line"?{"line-color":`hsl(${r.color.h},${r.color.s}%,${r.color.l}%)`,"line-opacity":r.color.a,"line-width":2}:r.renderingType==="circle"?{"circle-color":`hsl(${r.color.h},${r.color.s}%,${r.color.l}%)`,"circle-opacity":r.color.a,"circle-radius":5}:{}})},[a,r]),u.useEffect(()=>{var y;(y=a.current)==null||y.moveLayer(r.id,t)},[t,r.id,a,r.updater]),u.useEffect(()=>{var y;(y=a.current)==null||y.setLayoutProperty(r.id,"visibility",r.visible?"visible":"none")},[r.visible,a,r.id,r.updater]);const h=y=>{var b,S,f,x,j,g;c(r.id,y),r.renderingType==="fill"?((b=a.current)==null||b.setPaintProperty(r.id,"fill-color",`hsl(${y.h},${y.s}%,${y.l}%)`),(S=a.current)==null||S.setPaintProperty(r.id,"fill-opacity",y.a)):r.renderingType==="line"?((f=a.current)==null||f.setPaintProperty(r.id,"line-color",`hsl(${y.h},${y.s}%,${y.l}%)`),(x=a.current)==null||x.setPaintProperty(r.id,"line-opacity",y.a)):r.renderingType==="circle"&&((j=a.current)==null||j.setPaintProperty(r.id,"circle-color",`hsl(${y.h},${y.s}%,${y.l}%)`),(g=a.current)==null||g.setPaintProperty(r.id,"circle-opacity",y.a))},m=()=>{var y,b;(y=a.current)==null||y.removeLayer(r.id),(b=a.current)==null||b.removeSource(r.id),i(r.id)},C=()=>{const y=new Blob([JSON.stringify(r.featureCollection)],{type:"application/geo+json"}),b=URL.createObjectURL(y),S=document.createElement("a");S.href=b,S.download=r.name+".geojson",document.body.appendChild(S),S.click(),document.body.removeChild(S),URL.revokeObjectURL(b)},v=()=>{var b;const y=z(r.featureCollection).slice(0,4);(b=a.current)==null||b.fitBounds(y,{padding:20})},[k,L]=u.useState(!1);return e.jsxs("div",{className:"layerItem",children:[e.jsxs("span",{className:"layerIndex",children:[l+1,"."]}),e.jsx(nt,{color:r.color,onChange:h,layerType:r.renderingType}),e.jsx(ot,{layerId:r.id,initialLayerName:r.name,isEditing:k,setIsEditing:L,closeMenu:()=>n(!1)}),e.jsxs("div",{className:`layerMenu ${s?"open":""}`,ref:o,children:[e.jsx("button",{type:"button",onClick:()=>{n(!s)},children:e.jsx(Ce,{})}),s&&e.jsx("div",{className:"layerMenuPopover",children:e.jsxs("ul",{children:[e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:m,children:[e.jsx(Y,{})," Delete layer"]})}),e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:C,children:[e.jsx(Se,{})," Download layer"]})}),e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:v,children:[e.jsx(Le,{})," Zoom to layer"]})}),e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:y=>{y.stopPropagation(),L(!k)},children:[k?e.jsx(we,{}):e.jsx(Ne,{})," Edit layer name"]})}),e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:()=>{p([r])},children:[e.jsx(Q,{})," Attribute table"]})})]})})]}),e.jsx("button",{type:"button",onClick:()=>d(r.id),children:r.visible?e.jsx(_,{}):e.jsx(D,{})})]})},ct=()=>{const{layers:r,moveLayerUp:t,moveLayerDown:l}=w(),[s,n]=u.useState(null),[o,i]=u.useState(null);u.useEffect(()=>{s!==null&&i(s)},[s]);const d=(p,h)=>{n(h),p.dataTransfer.setDragImage(new Image,0,0)},c=(p,h)=>{p.preventDefault(),p.dataTransfer.dropEffect="move",!(s===null||s===h)&&(r.findIndex(m=>m.id===s)<r.findIndex(m=>m.id===h)?l(s):t(s))},a=()=>{n(null)};return e.jsx("ol",{className:"layerList",children:r.map((p,h)=>e.jsx("li",{draggable:!0,className:`layerListItem ${o===p.id?"hovering":""}`,onDragStart:m=>d(m,p.id),onDragOver:m=>c(m,p.id),onDragEnd:a,onMouseOver:()=>s===null?i(p.id):void 0,onMouseOut:()=>s===null?i(null):void 0,children:e.jsx(at,{layerData:p,layerAboveId:h===0?void 0:r[h-1].id,index:h})},p.id))})},ut=({headers:r,headerTypes:t})=>{const{filters:l,addFilter:s,removeFilter:n,updateFilter:o}=q();return e.jsxs("div",{className:"filterContainer",children:[l.map((i,d)=>e.jsxs("div",{className:"filterRow",children:[e.jsxs("select",{value:i.attribute,onChange:c=>o(d,{...i,attribute:c.target.value,attributeType:t[r.indexOf(c.target.value)]||"string"}),children:[e.jsx("option",{value:"",children:"Select an attribute"}),r.map(c=>e.jsx("option",{value:c,children:c},c))]}),e.jsx("select",{value:i.operator,onChange:c=>o(d,{...i,operator:c.target.value}),children:i.attributeType==="number"?lt.map(c=>e.jsx("option",{value:c,children:c},c)):it.map(c=>e.jsx("option",{value:c,children:c},c))}),e.jsx("input",{type:i.attributeType==="number"?"number":"text",placeholder:`Enter ${i.attributeType} value`,value:i.value,onChange:c=>o(d,{...i,value:i.attributeType==="number"?parseFloat(c.target.value):c.target.value})}),e.jsx("button",{type:"button",onClick:()=>{o(d,{...i,active:!i.active})},children:i.active?e.jsx(ke,{}):e.jsx(Pe,{})}),e.jsx("button",{onClick:()=>n(d),children:e.jsx(Y,{})})]},d)),e.jsx("button",{onClick:s,children:"Add Filter"})]})},dt=()=>{const{selectedLayer:r,setSelectedLayer:t,tableOpen:l,setTableOpen:s,filters:n}=q(),[o,i]=u.useState([]);u.useEffect(()=>{i(r.length>0?r[0].featureCollection.features.map((f,x)=>{const j={...f.properties||{},mugisSelected:!1,mugisIndex:x};return{...f,properties:j}}):[]),console.log("Selected layer changed:",r)},[r]);const d=u.useMemo(()=>{const f=new Set;return o.forEach(x=>{x&&x.properties&&Object.keys(x.properties).forEach(j=>f.add(j))}),f.delete("mugisSelected"),f.delete("mugisIndex"),f.forEach(x=>{o.map(g=>{var T;return(T=g.properties)==null?void 0:T[x]}).every(g=>Array.isArray(g)||g===null||g===void 0)&&f.delete(x)}),Array.from(f)},[o]),c=u.useMemo(()=>d.map(f=>o.map(j=>{var g;return(g=j.properties)==null?void 0:g[f]}).filter(j=>j!=null).every(j=>typeof j=="number")?"number":"string"),[d,o]),[a,p]=u.useState(!1),h=u.useMemo(()=>o.filter(f=>n.every(x=>{var B,U;const{active:j,attribute:g,attributeType:T,operator:$,value:P}=x;if(!j)return!0;if(T==="number"){const N=(B=f.properties)==null?void 0:B[g];if(N==null)switch($){case"=":return P===void 0||P===""||Number.isNaN(P);case"!=":return P!==void 0&&P!==""&&!Number.isNaN(P);default:return!1}const E=P;switch($){case"=":return N===E;case"!=":return N!==E;case"<":return N<E;case"<=":return N<=E;case">":return N>E;case">=":return N>=E;default:return!1}}else{const N=(U=f.properties)==null?void 0:U[g];if(N==null)switch($){case"=":return P===void 0||P==="";case"!=":return P!==void 0&&P!=="";default:return!1}const E=P;switch($){case"=":return String(N)===E;case"!=":return String(N)!==E;case"contains":return String(N).includes(E);case"does not contain":return!String(N).includes(E);case"starts with":return String(N).startsWith(E);case"does not start with":return!String(N).startsWith(E);case"ends with":return String(N).endsWith(E);case"does not end with":return!String(N).endsWith(E);default:return!1}}})),[o,n]),[m,C]=u.useState(null),[v,k]=u.useState(!0),L=u.useMemo(()=>m?[...h].sort((f,x)=>{const j=f&&f.properties&&m in f.properties?f.properties[m]??"":"",g=x&&x.properties&&m in x.properties?x.properties[m]??"":"";return j===g?0:j===void 0?1:g===void 0?-1:j<g?v?-1:1:j>g?v?1:-1:0}):h,[h,m,v]),y=f=>{m===f?v?k(!1):C(null):(C(f),k(!0))},{addLayer:b}=w(),S=()=>{if(r.length===0||o.length===0)return;const f=h.filter(x=>{var j;return(j=x.properties)==null?void 0:j.mugisSelected}).map(x=>({...x,properties:{...x.properties,mugisSelected:void 0,mugisIndex:void 0}}));f.length!==0&&(b({featureCollection:{type:"FeatureCollection",features:f},name:`selection(${r[0].name})`,outline:r[0].outline}),s(!1))};return e.jsxs("div",{children:[e.jsx("button",{type:"button",className:"toolButton",onClick:()=>s(!l),children:e.jsx(Q,{})}),l&&e.jsx("div",{className:"cover",onClick:f=>{f.target===f.currentTarget&&s(!1)},children:e.jsxs("div",{className:"attributeTable",children:[e.jsx("button",{type:"button",className:"modalCloseButton",onClick:()=>s(!1),children:e.jsx(X,{})}),e.jsx("h3",{children:"Attribute Table"}),e.jsxs("div",{className:"tableInputHeader",children:[e.jsx(F,{selectedLayers:r,setSelectedLayers:t}),e.jsxs("button",{type:"button",className:`openFilterButton ${n.some(f=>f.active)?"active":""}`,onClick:()=>p(!a),children:[e.jsx(Ee,{})," ",a?"Close Filter":"Open Filter"]})]}),a&&e.jsx(ut,{headers:d,headerTypes:c}),e.jsx("div",{className:"tableContainer",children:r.length>0&&e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:e.jsx("button",{type:"button",className:"selectAll",onClick:()=>{h.every(f=>{var x;return!((x=f.properties)!=null&&x.mugisSelected)})?i(f=>f.map(x=>{const j={...x.properties||{},mugisSelected:!0};return{...x,properties:j}})):i(f=>f.map(x=>{const j={...x.properties||{},mugisSelected:!1};return{...x,properties:j}}))},children:h.every(f=>f.properties.mugisSelected)?e.jsx(H,{}):h.every(f=>!f.properties.mugisSelected)?e.jsx(J,{}):e.jsx(Fe,{})})}),d.map((f,x)=>e.jsx("th",{children:e.jsxs("button",{type:"button",onClick:()=>y(f),children:[f,e.jsx("div",{className:"sortIcon",children:m===f&&(v?e.jsx(Te,{}):e.jsx(Oe,{}))})]})},x))]})}),e.jsx("tbody",{children:L.map((f,x)=>{var j;return e.jsxs("tr",{className:(j=f.properties)!=null&&j.mugisSelected?"selected":"",children:[e.jsx("td",{children:e.jsx("button",{type:"button",onClick:()=>{i(g=>g.map((T,$)=>{var P,B;if($===((P=f.properties)==null?void 0:P.mugisIndex)){const U={...T.properties||{},mugisSelected:!((B=T.properties)!=null&&B.mugisSelected)};return{...T,properties:U}}return T}))},children:f.properties.mugisSelected?e.jsx(H,{}):e.jsx(J,{})})}),d.map((g,T)=>e.jsx("td",{children:f.properties&&!Array.isArray(f.properties[g])&&f.properties[g]!==null&&f.properties[g]!==void 0?String(f.properties[g]):""},T))]},x)})})]})}),e.jsxs("button",{type:"button",onClick:S,children:["Create Layer From Selection",h.filter(f=>{var x;return(x=f.properties)==null?void 0:x.mugisSelected}).length>0&&` (${h.filter(f=>{var x;return(x=f.properties)==null?void 0:x.mugisSelected}).length} selected)`]})]})})]})},pt=({handleLoadFileInput:r})=>{const[t,l]=u.useState(!0),[s,n]=u.useState(300),{layers:o,toggleLayerVisibilityAll:i}=w(),{mapRef:d,mapReady:c}=R();u.useEffect(()=>{const h=setInterval(()=>{var m;(m=d.current)==null||m.resize()},1);setTimeout(()=>{clearInterval(h)},1)},[d,t]);const a=u.useRef(null),p=()=>{a.current&&a.current.click()};return e.jsxs("div",{className:`sidebarContainer ${t?"open":""}`,children:[e.jsx(st,{setWidth:n,setOpen:l}),e.jsxs("aside",{className:"sidebar",style:{width:`${s}px`},children:[e.jsxs("div",{className:"sidebarHeader",children:[e.jsx("h2",{children:"Layers"}),e.jsxs("div",{className:"sidebarHeaderActions",children:[e.jsx(dt,{}),e.jsx("button",{type:"button",onClick:i,children:o.every(h=>h.visible)?e.jsx(_,{}):e.jsx(D,{})})]})]}),e.jsx("div",{className:"layerListContainer",children:c&&e.jsx(ct,{})}),e.jsxs("div",{className:"sidebarFooter",children:[e.jsxs("button",{type:"button",onClick:p,children:[e.jsx($e,{})," Upload GeoJSON file"]}),e.jsx("input",{ref:a,type:"file",multiple:!0,accept:".geojson",onChange:r})]})]})]})};function ft(){const{addLayer:r}=w(),t=n=>{if(!n){console.log("no file selected");return}Array.from(n).forEach(o=>{const i=new FileReader;i.onload=d=>{var c;try{const a=JSON.parse((c=d.target)==null?void 0:c.result);if(a.type!=="FeatureCollection")throw new Error("Not a valid GeoJSON file, must be a FeatureCollection");r({featureCollection:a,name:o.name})}catch(a){console.log(a),alert("Error loading file: "+o.name+`
`+(a instanceof Error?a.message:String(a)))}},i.readAsText(o)})},l=n=>{t(n.target.files),n.target.value=""},s=n=>{n.preventDefault(),t(n.dataTransfer.files)};return e.jsxs("div",{className:"pageContainer",onDragOver:n=>n.preventDefault(),onDrop:s,children:[e.jsxs("header",{className:"mainHeader",children:[e.jsx("h1",{children:"μGIS"}),e.jsx(rt,{}),e.jsx(Ge,{})]}),e.jsxs("main",{className:"mainContainer",children:[e.jsx(pt,{handleLoadFileInput:l}),e.jsx("div",{className:"mapFlexContainer",children:e.jsx(qe,{})})]})]})}Me.createRoot(document.getElementById("root")).render(e.jsx(u.StrictMode,{children:e.jsx(ft,{})}));
