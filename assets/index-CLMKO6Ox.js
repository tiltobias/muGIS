import{c as M,r as u,j as n,a as E,E as $,T as F,F as T,Z as I,C as U,b as B,d as O,e as w,S as A,f as G,g as J,h as V,M as Z,G as z,U as W,i as _}from"./vendor-react-CnEhMI5I.js";import{m as v,M as q}from"./vendor-mapbox-Cdbn7qN2.js";import{b as H,a as K}from"./vendor-turf-BDOaYuTp.js";import"./vendor-BCRZ06SV.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const l of t)if(l.type==="childList")for(const p of l.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&o(p)}).observe(document,{childList:!0,subtree:!0});function s(t){const l={};return t.integrity&&(l.integrity=t.integrity),t.referrerPolicy&&(l.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?l.credentials="include":t.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(t){if(t.ep)return;t.ep=!0;const l=s(t);fetch(t.href,l)}})();const L=M(e=>({mapRef:u.createRef(),setMapRef:r=>e({mapRef:r}),mapReady:!1,setMapReady:r=>e({mapReady:r})})),P=M(e=>({layers:[],resetLayerStore:()=>e(()=>({layers:[]})),loadProjectLayers:r=>e(()=>({layers:r})),addLayer:r=>e(s=>{const o=m=>s.layers.some(y=>y.id===m)?o(m+"1"):m,t=r.featureCollection.features[0].geometry.type,l=t==="Polygon"||t==="MultiPolygon"?"fill":t==="LineString"||t==="MultiLineString"?"line":t==="Point"||t==="MultiPoint"?"circle":null;if(!l)throw new Error("Unsupported geometry type: "+t);r.name||(r.name=l==="fill"?"polygon layer":l==="line"?"line layer":l==="circle"?"point layer":"not possible");const p={h:Math.floor(Math.random()*360),s:90,l:48,a:l==="fill"?.7:1};return{layers:[{featureCollection:r.featureCollection,id:o(r.name),name:r.name,renderingType:l,visible:!0,color:p},...s.layers]}}),moveLayerUp:r=>e(s=>{const o=s.layers.findIndex(l=>l.id===r);if(o===0)return s;const t=[...s.layers];return t.splice(o-1,0,t.splice(o,1)[0]),{layers:t}}),moveLayerDown:r=>e(s=>{const o=s.layers.findIndex(l=>l.id===r);if(o===s.layers.length-1)return s;const t=[...s.layers];return t.splice(o+1,0,t.splice(o,1)[0]),{layers:t}}),deleteLayer:r=>e(s=>({layers:s.layers.filter(o=>o.id!==r)})),toggleLayerVisibility:r=>e(s=>({layers:s.layers.map(o=>o.id===r?{...o,visible:!o.visible}:o)})),toggleLayerVisibilityAll:()=>e(r=>{const s=r.layers.every(o=>o.visible);return{layers:r.layers.map(o=>({...o,visible:!s}))}}),changeLayerColor:(r,s)=>e(o=>({layers:o.layers.map(t=>t.id===r?{...t,color:s}:t)}))}));v.accessToken="pk.eyJ1IjoidG9iaWFuZCIsImEiOiJjbTdiMGZwemwwNmxlMnFyNTV4YWh2ZzB3In0.B3fVZMQOYEs2V23kKWB5XQ";const Q=()=>{const{mapRef:e,mapReady:r,setMapReady:s}=L(),{addLayer:o}=P(),t=u.useRef(null);return u.useEffect(()=>{var l,p,b,m,y,d;if(!r&&t.current){t.current.innerHTML="",e.current=new v.Map({container:t.current,style:"mapbox://styles/mapbox/streets-v12",center:[10.4,63.425],zoom:12}),(l=e.current)==null||l.addControl(new v.FullscreenControl,"top-right"),(p=e.current)==null||p.addControl(new v.NavigationControl({visualizePitch:!0}),"top-right"),(b=e.current)==null||b.addControl(new v.ScaleControl,"bottom-right");const c=new q({displayControlsDefault:!1,controls:{point:!0,line_string:!0,polygon:!0},boxSelect:!1});(m=e.current)==null||m.addControl(c,"bottom-left"),(y=e.current)==null||y.on("draw.create",()=>{o({featureCollection:c.getAll(),name:null}),c.deleteAll()}),(d=e.current)==null||d.on("style.load",()=>{s(!0)})}},[e,o,r,s]),n.jsx("div",{ref:t,className:"mapContainer"})},N=(e,r)=>{u.useEffect(()=>{const s=o=>{e.current&&!e.current.contains(o.target)&&r()};return document.addEventListener("click",s),()=>{document.removeEventListener("click",s)}},[e,r])},Y=({color:e,onChange:r})=>{const[s,o]=u.useState(!1),t=u.useRef(null);return N(t,()=>{o(!1)}),n.jsxs("div",{className:"colorPicker",ref:t,children:[n.jsx("button",{type:"button",className:"colorPickerButton",onClick:()=>{o(!s)},style:{backgroundColor:`hsl(${e.h},${e.s}%,${e.l}%)`}}),s&&n.jsx("div",{className:"colorPickerPopover",children:n.jsx(E,{color:e,onChange:l=>{r(l)}})})]})},X=({layerData:e,layerAboveId:r})=>{const[s]=u.useState(e.name),[o,t]=u.useState(!1),l=u.useRef(null);N(l,()=>{t(!1)});const{moveLayerUp:p,moveLayerDown:b,deleteLayer:m,toggleLayerVisibility:y,changeLayerColor:d}=P(),{mapRef:c}=L();u.useEffect(()=>{var i,a,f,C;(i=c.current)!=null&&i.getSource(e.id)||(a=c.current)==null||a.addSource(e.id,{type:"geojson",data:e.featureCollection}),(f=c.current)!=null&&f.getLayer(e.id)||(C=c.current)==null||C.addLayer({id:e.id,type:e.renderingType,source:e.id,paint:e.renderingType==="fill"?{"fill-color":`hsl(${e.color.h},${e.color.s}%,${e.color.l}%)`,"fill-opacity":e.color.a}:e.renderingType==="line"?{"line-color":`hsl(${e.color.h},${e.color.s}%,${e.color.l}%)`,"line-opacity":e.color.a,"line-width":2}:e.renderingType==="circle"?{"circle-color":`hsl(${e.color.h},${e.color.s}%,${e.color.l}%)`,"circle-opacity":e.color.a,"circle-radius":5}:{}})},[c,e,e.color]),u.useEffect(()=>{var i;(i=c.current)==null||i.moveLayer(e.id,r)},[r,e.id,c]),u.useEffect(()=>{var i;(i=c.current)==null||i.setLayoutProperty(e.id,"visibility",e.visible?"visible":"none")},[e.visible,e.id,c]);const j=i=>{var a,f,C,S,k,R;d(e.id,i),e.renderingType==="fill"?((a=c.current)==null||a.setPaintProperty(e.id,"fill-color",`hsl(${i.h},${i.s}%,${i.l}%)`),(f=c.current)==null||f.setPaintProperty(e.id,"fill-opacity",i.a)):e.renderingType==="line"?((C=c.current)==null||C.setPaintProperty(e.id,"line-color",`hsl(${i.h},${i.s}%,${i.l}%)`),(S=c.current)==null||S.setPaintProperty(e.id,"line-opacity",i.a)):e.renderingType==="circle"&&((k=c.current)==null||k.setPaintProperty(e.id,"circle-color",`hsl(${i.h},${i.s}%,${i.l}%)`),(R=c.current)==null||R.setPaintProperty(e.id,"circle-opacity",i.a))},x=i=>{var a,f;(a=c.current)==null||a.removeLayer(i),(f=c.current)==null||f.removeSource(i),m(i)},h=()=>{const i=new Blob([JSON.stringify(e.featureCollection)],{type:"application/geo+json"}),a=URL.createObjectURL(i),f=document.createElement("a");f.href=a,f.download=e.id+".geojson",document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(a)},g=()=>{var a;const i=H(e.featureCollection).slice(0,4);(a=c.current)==null||a.fitBounds(i,{padding:20})};return n.jsx("li",{className:"layerListItem",children:n.jsxs("div",{className:"layerItem",children:[n.jsx(Y,{color:e.color,onChange:j}),n.jsx("div",{className:"layerName",children:s}),n.jsxs("div",{className:"layerMenu",ref:l,children:[n.jsx("button",{type:"button",onClick:()=>{t(!o)},children:n.jsx($,{})}),o&&n.jsx("div",{className:"layerMenuPopover",children:n.jsxs("ul",{children:[n.jsx("li",{children:n.jsx("button",{type:"button",onClick:()=>x(e.id),children:n.jsx(F,{})})}),n.jsx("li",{children:n.jsx("button",{type:"button",onClick:h,children:n.jsx(T,{})})}),n.jsx("li",{children:n.jsx("button",{type:"button",onClick:g,children:n.jsx(I,{})})})]})})]}),n.jsxs("div",{className:"layerMoveControls",children:[n.jsx("button",{type:"button",onClick:()=>p(e.id),children:n.jsx(U,{})}),n.jsx("button",{type:"button",onClick:()=>b(e.id),children:n.jsx(B,{})})]}),n.jsx("button",{type:"button",onClick:()=>y(e.id),children:e.visible?n.jsx(O,{}):n.jsx(w,{})})]})})},D=()=>{const[e,r]=u.useState(!1),s=u.useRef(null);N(s,()=>{r(!1)});const{layers:o,resetLayerStore:t,loadProjectLayers:l}=P(),{setMapReady:p}=L(),b=()=>{t(),p(!1)},m=()=>{const j=new Blob([JSON.stringify(o)],{type:"application/json"}),x=URL.createObjectURL(j),h=document.createElement("a");h.href=x,h.download="μGIS_project.mugis",document.body.appendChild(h),h.click(),document.body.removeChild(h),URL.revokeObjectURL(x)},y=u.useRef(null),d=()=>{var j;(j=y.current)==null||j.click()},c=j=>{const x=j.target.files;if(!x){console.log("no file selected");return}const h=new FileReader;h.onload=g=>{var i;try{const a=JSON.parse((i=g.target)==null?void 0:i.result);l(a)}catch(a){console.log(a)}},b(),h.readAsText(x[0])};return n.jsxs("div",{className:"settings",ref:s,children:[n.jsx("button",{type:"button",onClick:()=>{r(!e)},children:n.jsx(A,{})}),e&&n.jsx("div",{className:"settingsPopover",children:n.jsxs("ul",{children:[n.jsx("li",{children:n.jsxs("button",{type:"button",onClick:b,children:[n.jsx(G,{})," New project"]})}),n.jsx("li",{children:n.jsxs("button",{type:"button",onClick:m,children:[n.jsx(J,{})," Save project"]})}),n.jsxs("li",{children:[n.jsx("input",{ref:y,type:"file",accept:".mugis",onChange:c}),n.jsxs("button",{type:"button",onClick:d,children:[n.jsx(V,{})," Load project"]})]}),n.jsx("li",{children:n.jsxs("button",{type:"button",onClick:()=>{},children:[n.jsx(Z,{})," Change basemap"]})}),n.jsx("li",{children:n.jsxs("button",{type:"button",onClick:()=>{},children:[n.jsx(z,{})," Start tutorial"]})})]})})]})};function ee(){const[e,r]=u.useState(!0),{layers:s,addLayer:o,toggleLayerVisibilityAll:t}=P(),{mapRef:l,mapReady:p}=L(),b=()=>{r(!e),setTimeout(()=>{var d;(d=l.current)==null||d.resize()},1),setTimeout(()=>{var d;(d=l.current)==null||d.resize()},100)},m=d=>{const c=d.target.files;if(!c){console.log("no file selected");return}Array.from(c).forEach(j=>{const x=new FileReader;x.onload=h=>{var g;try{const i=JSON.parse((g=h.target)==null?void 0:g.result);if(i.type!=="FeatureCollection")throw new Error("Not a valid GeoJSON file, must be a FeatureCollection");o({featureCollection:i,name:j.name})}catch(i){console.log(i)}},x.readAsText(j)})},y=()=>{const d=s[0],c=K(d.featureCollection,.05);c?o({featureCollection:c,name:d.name+"_buffer"}):console.error("Buffer operation failed")};return n.jsxs("div",{className:"pageContainer",children:[n.jsxs("header",{className:"mainHeader",children:[n.jsx("h1",{children:"μGIS"}),n.jsx("button",{type:"button",onClick:b,children:"Sidebar"}),n.jsx("button",{type:"button",onClick:y,children:"Buffer"}),n.jsx(D,{})]}),n.jsxs("main",{className:"mainContainer",children:[n.jsx("div",{className:`sidebarContainer ${e?"open":""}`,children:n.jsxs("aside",{className:"sidebar",children:[n.jsx("h2",{children:"Sidebar"}),n.jsx("button",{type:"button",onClick:t,children:s.every(d=>d.visible)?n.jsx(O,{}):n.jsx(w,{})}),n.jsx("div",{className:"layerListContainer",children:p&&n.jsx("ol",{className:"layerList",children:s.map((d,c)=>n.jsx(X,{layerData:d,layerAboveId:c===0?void 0:s[c-1].id},d.id))})}),n.jsxs("div",{className:"sidebarFooter",children:[n.jsxs("label",{htmlFor:"layerFileInput",children:[n.jsx(W,{}),"Upload GeoJSON file"]}),n.jsx("input",{id:"layerFileInput",type:"file",multiple:!0,accept:".geojson",onChange:m})]})]})}),n.jsx("div",{className:"mapFlexContainer",children:n.jsx(Q,{})})]})]})}_.createRoot(document.getElementById("root")).render(n.jsx(u.StrictMode,{children:n.jsx(ee,{})}));
